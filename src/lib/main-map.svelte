<script lang="ts">
    import { APIProvider, GoogleMap, AdvancedMarker, Marker } from 'svelte-google-maps-api';
    import { env } from '$env/dynamic/public';
    import places from '../../src/data.json';
    import OverlayPanel from '$lib/placeInfo.svelte'
  
    const apiKey = "AIzaSyBFXc6xalH0Z7Y0JMFGA_eYy6_i1f1awq8";
    const mapId = "fc5b6b347cf6f1b161dcb699"; // einzelner String
    const libraries = ['marker']; // WICHTIG: AdvancedMarker braucht diese Library

    const mapOptions = {
        center: { lat: 48.21327705958343, lng: 16.36358758074824 },
        zoom: 12,
        mapId: mapId,
        gestureHandling: 'greedy',
        /*
        fullscreenControl: false,
        streetViewControl: false,
        cameraControl: false,
        */
        disableDefaultUI: true
    };

    let locations: any[] = []

    places.forEach(element => {
      locations.push(
        {
          placeId: element['Place Id - Location'],
          position: {lat: element['Latitude - Location'], lng: element['Longitude - Location']}
        }
      )
    });

    let overlayOpen = false;
    let selected: any = null;
  
    function handleMarkerClick(placeId:string) {
      selected = placeId;
      overlayOpen = true;
    }

    function close() { overlayOpen = false; }
  </script>
  
  <div class="map-wrap">
    <APIProvider {apiKey} libraries={['marker']}>
      <GoogleMap id="map" options={mapOptions} mapContainerStyle="width: 100%; height: 100%;">
        {#each locations as location}
        <Marker 
            position={location.position} 
            onClick={() => handleMarkerClick(location.placeId)}
        />
        {/each}
      </GoogleMap>
    </APIProvider>

    <OverlayPanel placeId={selected} open={overlayOpen} onClose={close}></OverlayPanel>
  </div>

  <style>
    .map-wrap {
    /* Variante A: dynamische Viewport-HÃ¶he (iOS 16+ gut) */
    height: 100dvh;
    width: 100%;
    /* Hilft Safari, Touch-Gesten direkt weiterzureichen */
    touch-action: manipulation;
  }
  </style>

  